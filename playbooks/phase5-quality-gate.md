# Phase 5: Quality Gate プレイブック

> プロダクションコードの品質・安全性・性能を横断的に検証し、リリース可能な状態を担保する

## 前提条件

- Phase 4 が完了していること（aidlc-docs/aidlc-state.md で確認）
- プロダクションコードが動作する状態であること
- 全テストがパスしていること

## フェーズ開始時の成果物読み込み

Phase 5 の各ステップに入る前に、以下の成果物を読み込む:

- `aidlc-docs/inception/requirements.md`（非機能要件の確認）
- `aidlc-docs/construction/architecture.md`（技術スタックの確認）
- `aidlc-docs/construction/data-model.md`（データモデルの確認）

---

## Step 1: Quality Check & Auto-Fix（品質チェック・自動修正）

### AIの行動

1. **テストを実行する**
   - 全テストを実行し、通ることを確認する
   - テストが失敗する場合は修正する

2. **コード品質チェックを実行する**
   - Lint / Format チェックを実行し、違反があれば自動修正する
   - 型チェックを実行し、エラーがあれば修正する
   - コード重複を検出し、共通化・リファクタリングする
   - テストカバレッジを測定し、カバレッジが低い箇所にテストを追加する
   - コードの複雑度を分析し、過度に複雑な箇所を特定する
   - 不要コード（デッドコード、未使用 import 等）を検出・削除する

3. **セキュリティチェックを実行する**
   - 依存パッケージの脆弱性をスキャンする
   - ソースコード内の secrets / credentials を検出する
   - 入力バリデーションの漏れをチェックする
   - OWASP Top 10 の観点でコードをレビューする（XSS、インジェクション等）

4. **パフォーマンスチェックを実行する**
   - バンドルサイズを分析する（フロントエンドの場合）
   - N+1 クエリ等の非効率なデータアクセスを検出する（バックエンドの場合）
   - メモリリークの可能性がある箇所を特定する
   - 不要な再レンダリング等のランタイム性能問題を検出する

5. **自動修正可能な問題を修正する**
   - Lint / Format 違反を自動修正する
   - 簡易なセキュリティ修正（依存パッケージのアップデート等）を実施する
   - 修正後、全テストを再実行してリグレッションがないことを確認する

6. **品質レポートを生成する**
   - チェック結果をカテゴリ別にまとめる
   - 自動修正した内容を記録する
   - 残存する問題と対応方針を記述する
   - 総合的な品質評価を記述する

### 成果物の生成

- `aidlc-docs/quality-gate/report.md` を生成する
- テンプレート: `templates/quality-gate/report.md` を使用

### 記録

- `aidlc-docs/audit.md` に品質チェックの結果サマリーを記録する

### 完了条件

- 全テストが通っている
- 全品質チェックが実行された
- 自動修正可能な問題が修正された
- 品質レポートが生成された（テスト結果を含む）
- `aidlc-docs/aidlc-state.md` の Step 1 チェックボックスを `[x]` にする

---

## Step 2: Approval Gate（Go/No-Go 判断）

> **承認ゲート**: 品質レポートを人間がレビューし、リリース可能かを判断する。

### AIの行動

1. **品質レポートの要約を提示する**
   - 品質レポートの要点を提示する:
     - コード品質: Lint / 型チェック / カバレッジの結果
     - セキュリティ: 脆弱性・リスクの有無
     - パフォーマンス: 問題の有無
     - 自動修正した件数と残存する問題
   - 「品質レポートをご確認ください。Phase 6 に進めてよいですか？」と問う

2. **人間の判断を受ける**
   - **Go**: Phase 6 (Delivery) に進む
   - **No-Go（追加修正が必要）**: 指摘された問題を AI が修正し、Step 1 を再実行する
   - **No-Go（実装の根本的な見直しが必要）**: Phase 4 (Construction) に戻る

### 記録

- `aidlc-docs/audit.md` に Go/No-Go 判断と理由を記録する

### 完了条件

- 人間が Go 判断を下した
- `aidlc-docs/aidlc-state.md` の Step 2 チェックボックスを `[x]` にする
- `aidlc-docs/aidlc-state.md` の `Current Phase` を `Phase 6 - Delivery` に更新する
